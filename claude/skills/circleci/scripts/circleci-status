#!/bin/bash
#
# circleci-status - Check CircleCI pipeline/workflow/job status
#
# Usage:
#   circleci-status                     # Show latest pipeline status
#   circleci-status -b <branch>         # Show latest pipeline for branch
#   circleci-status -p <pipeline-id>    # Show workflows for pipeline
#   circleci-status -w <workflow-id>    # Show jobs for workflow
#   circleci-status -j <job-number>     # Show job details
#

set -e

# Configuration
API_BASE="https://circleci.com/api/v2"

# Get project slug from environment or detect from git remote
if [[ -n "$CIRCLECI_PROJECT_SLUG" ]]; then
    PROJECT_SLUG="$CIRCLECI_PROJECT_SLUG"
else
    # Try to detect from git remote origin
    REMOTE_URL=$(git remote get-url origin 2>/dev/null || true)
    if [[ -n "$REMOTE_URL" ]]; then
        # Extract org/repo from git@github.com:org/repo.git or https://github.com/org/repo.git
        PROJECT_SLUG=$(echo "$REMOTE_URL" | sed -E 's#(git@github\.com:|https://github\.com/)##' | sed 's/\.git$//')
        PROJECT_SLUG="gh/$PROJECT_SLUG"
    else
        echo "Error: CIRCLECI_PROJECT_SLUG not set and could not detect from git remote"
        echo "Set CIRCLECI_PROJECT_SLUG environment variable (e.g., gh/org/repo)"
        exit 1
    fi
fi

# Get token from environment or CircleCI CLI config
if [[ -z "$CIRCLE_TOKEN" ]]; then
    CLI_CONFIG="$HOME/.circleci/cli.yml"
    if [[ -f "$CLI_CONFIG" ]]; then
        CIRCLE_TOKEN=$(grep "^token:" "$CLI_CONFIG" | awk '{print $2}')
    fi
    if [[ -z "$CIRCLE_TOKEN" ]]; then
        echo "Error: CIRCLE_TOKEN not set and not found in ~/.circleci/cli.yml"
        echo "Run 'circleci setup' or set CIRCLE_TOKEN environment variable"
        exit 1
    fi
fi

# Check for jq
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed"
    exit 1
fi

api_get() {
    curl -s "$1" --header "Circle-Token: $CIRCLE_TOKEN"
}

show_pipelines() {
    local branch="$1"
    local url="$API_BASE/project/$PROJECT_SLUG/pipeline"

    if [[ -n "$branch" ]]; then
        url="$url?branch=$branch"
    fi

    echo "=== Recent Pipelines ==="
    api_get "$url" | jq -r '
        .items[:5] | .[] |
        "Pipeline #\(.number) [\(.state)] - \(.created_at | split("T")[0]) \(.trigger.type)"
    '
}

show_latest_pipeline() {
    local branch="$1"
    local url="$API_BASE/project/$PROJECT_SLUG/pipeline"

    if [[ -n "$branch" ]]; then
        url="$url?branch=$branch"
    fi

    local pipeline_info
    pipeline_info=$(api_get "$url")

    local pipeline_id
    pipeline_id=$(echo "$pipeline_info" | jq -r '.items[0].id')

    if [[ "$pipeline_id" == "null" || -z "$pipeline_id" ]]; then
        echo "No pipelines found"
        exit 1
    fi

    echo "=== Latest Pipeline ==="
    echo "$pipeline_info" | jq -r '
        .items[0] |
        "Pipeline #\(.number) [\(.state)]",
        "  Created: \(.created_at)",
        "  Trigger: \(.trigger.type)",
        "  ID: \(.id)"
    '

    echo ""
    show_workflows "$pipeline_id"
}

show_workflows() {
    local pipeline_id="$1"

    echo "=== Workflows ==="
    local workflow_info
    workflow_info=$(api_get "$API_BASE/pipeline/$pipeline_id/workflow")

    echo "$workflow_info" | jq -r '
        .items[] |
        "  \(.name): \(.status) (ID: \(.id))"
    '

    # Show jobs for first workflow
    local workflow_id
    workflow_id=$(echo "$workflow_info" | jq -r '.items[0].id')

    if [[ "$workflow_id" != "null" && -n "$workflow_id" ]]; then
        echo ""
        show_jobs "$workflow_id"
    fi
}

show_jobs() {
    local workflow_id="$1"

    echo "=== Jobs ==="
    api_get "$API_BASE/workflow/$workflow_id/job" | jq -r '
        .items[] |
        "  \(.name): \(.status) (#\(.job_number))"
    '
}

show_job_details() {
    local job_number="$1"

    echo "=== Job #$job_number Details ==="
    api_get "$API_BASE/project/$PROJECT_SLUG/job/$job_number" | jq -r '
        "Name: \(.name)",
        "Status: \(.status)",
        "Started: \(.started_at)",
        "Duration: \(.duration // "running")s"
    '
}

# Parse arguments
BRANCH=""
PIPELINE_ID=""
WORKFLOW_ID=""
JOB_NUMBER=""

while getopts "b:p:w:j:h" opt; do
    case $opt in
        b) BRANCH="$OPTARG" ;;
        p) PIPELINE_ID="$OPTARG" ;;
        w) WORKFLOW_ID="$OPTARG" ;;
        j) JOB_NUMBER="$OPTARG" ;;
        h)
            echo "Usage: circleci-status [options]"
            echo ""
            echo "Options:"
            echo "  -b <branch>       Show latest pipeline for branch"
            echo "  -p <pipeline-id>  Show workflows for pipeline"
            echo "  -w <workflow-id>  Show jobs for workflow"
            echo "  -j <job-number>   Show job details"
            echo ""
            echo "Environment:"
            echo "  CIRCLE_TOKEN              Required. CircleCI API token"
            echo "  CIRCLECI_PROJECT_SLUG     Project slug (e.g., gh/org/repo). Auto-detected from git remote if not set."
            exit 0
            ;;
        *)
            echo "Use -h for help"
            exit 1
            ;;
    esac
done

# Execute based on arguments
if [[ -n "$JOB_NUMBER" ]]; then
    show_job_details "$JOB_NUMBER"
elif [[ -n "$WORKFLOW_ID" ]]; then
    show_jobs "$WORKFLOW_ID"
elif [[ -n "$PIPELINE_ID" ]]; then
    show_workflows "$PIPELINE_ID"
else
    show_latest_pipeline "$BRANCH"
fi
